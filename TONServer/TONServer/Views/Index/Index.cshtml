@{
    var lang = (Lang)ViewBag.lang;
    ViewBag.Title = lang["Главная"];
}

<script src="https://unpkg.com/@tonconnect/ui@2/dist/tonconnect-ui.min.js"></script>
<script>
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: `${window.location.origin}/tonconnect-manifest.json`
    });
    let tonConnectSession = null;
    let tonkeeperLinks = null;

    tonConnectUI.onStatusChange(function (wallet) {
        if (!wallet && tonConnectSession) {
            tonConnectSession = null;
            tonConnectUI.setConnectRequestParameters(null);
            updateTonkeeperLinks(null);
            return;
        }
        if (tonConnectSession) {
            handleTonConnectWallet(wallet);
        }
    });
    tonConnectUI.connectionRestored.then(function (wallet) {
        handleTonConnectWallet(wallet);
    });

    $(document).ready(function () {
        var params = new URLSearchParams(window.location.search);
        var sessionParam = params.get('session');
        if (sessionParam) {
            Cookies.set('session', sessionParam, { path: '/' });
            startTonConnect(sessionParam);
            if (window.history && window.history.replaceState) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    });

    function go() {
        var address = $('#address').val();
        if (address == '') showTonConnectError('Необходимо ввести адрес');
        else location.href = '../../' + address;
    }

    function home() {
        var session = randomString(20);
        Cookies.set('session', session, { path: '/' });
        try { tonConnectUI.disconnect(); } catch (e) { }
        startTonConnect(session);
    }

    function startTonConnect(session) {
        tonConnectSession = session;
        updateTonkeeperLinks(null);
        $.ajax({
            url: '/index/gettonconnectpayload',
            type: 'POST',
            data: { session: session },
            success: function (data) {
                if (data.r === 'ok') {
                    tonConnectUI.setConnectRequestParameters({
                        state: 'ready',
                        value: { tonProof: { payload: data.payload } }
                    });
                    updateTonkeeperLinks(data.links);
                    tonConnectUI.openModal();
                } else if (data.m) {
                    tonConnectSession = null;
                    showTonConnectError(data.m);
                    updateTonkeeperLinks(null);
                }
            },
            error: function () {
                tonConnectSession = null;
                showTonConnectError('Не удалось запросить TonConnect payload');
                updateTonkeeperLinks(null);
            }
        });
    }

    function handleTonConnectWallet(wallet) {
        if (!wallet || !wallet.account) return;
        if (!tonConnectSession && !wallet.connectItems) return;

        var proofItem = wallet.connectItems && wallet.connectItems.tonProof;
        if (!proofItem || !proofItem.proof) return;

        var proof = $.extend({}, proofItem.proof);
        if (proofItem.state_init) proof.state_init = proofItem.state_init;

        var session = tonConnectSession;
        tonConnectSession = null;
        if (!session) return;

        $.ajax({
            url: '/room/tonconnectauth',
            type: 'POST',
            data: {
                session: session,
                address: wallet.account.address,
                proof: JSON.stringify(proof)
            },
            success: function (data) {
                if (data.r === 'ok') {
                    tonConnectUI.setConnectRequestParameters(null);
                    tonConnectUI.closeModal();
                    updateTonkeeperLinks(null);
                    location.href = '/' + data.address;
                } else {
                    tonConnectSession = session;
                    if (data.m) showTonConnectError(data.m);
                }
            },
            error: function () {
                tonConnectSession = session;
                showTonConnectError('Не удалось подтвердить подпись TonConnect');
            }
        });
    }

    function showTonConnectError(message) {
        if (typeof er === 'function') er(message); else alert(message);
    }

    function updateTonkeeperLinks(links) {
        tonkeeperLinks = links || null;
        if (!tonkeeperLinks) {
            $('#tonkeeperLinks').hide();
            return;
        }
        $('#tonkeeperLinks').show();
        $('#tonkeeperUniversal').attr('href', tonkeeperLinks.tonkeeperUniversal);
        $('#tonkeeperApp').attr('href', tonkeeperLinks.tonkeeperDeeplink);
        $('#tonDeepLink').attr('href', tonkeeperLinks.tonDeeplink);
    }

    function randomString(length) {
        var result = '';
        var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for (var i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }
</script>

<div class="main-input">
    <div class="flex1">
        <input id="address" type="text" placeholder="TON address" style="background: #0000002e; color: #fff" /><br /><br />
        <button class="btn btn-green default" onclick="go()">Вперед</button>
        <button class="btn btn-green" onclick="home()" style="margin-left: 20px">Домой</button>
        <div id="tonkeeperLinks" style="display: none; margin-top: 20px;">
            <div style="margin-bottom: 10px; color: #fff;">Или откройте Tonkeeper напрямую:</div>
            <div class="flex" style="gap: 10px; flex-wrap: wrap;">
                <a id="tonkeeperUniversal" class="btn" target="_blank" rel="noopener">Tonkeeper (universal link)</a>
                <a id="tonkeeperApp" class="btn" href="#">Tonkeeper приложение</a>
                <a id="tonDeepLink" class="btn" href="#">ton:// ссылка</a>
            </div>
        </div>
    </div>
</div>
